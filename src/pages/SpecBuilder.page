<apex:page title="Specification Builder" controller="SpecificationController" action="{!init}">
	<apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" />
	<script type="text/javascript">

var	$j = jQuery.noConflict()
	specificationId = '{!specificationId}';

function loadSpecification( callback ){

	Spec.SpecificationController.getSpecification( specificationId, function( result, event ){
console.log(event);
console.log(result);

		var specification;

		if( event.status ){
			specification = result;
		}
		else if( event.type === 'exception' ){
			console.log( event.message );
		}
		else{
			console.log( event.message );
		}

		callback( $j('<div>').html( specification ).text() );
	});
}

function displaySpecification( specificationString ){

	console.log( specificationString );

	var specification = $j.parseJSON( specificationString );

	if( specification ){

		console.log( specification );

		renderSpec( specification, $j('#specification_container') );
	}
}

function renderSpec( specification, $container ){

	var $new_div = $j('<div>'), $list, $list_el;

	if( 'and' === specification.node || 'or' === specification.node ){
		if( 'and' === specification.node ){

			$new_div.text('And');
		}
		else{

			$new_div.text('Or');
		}

		$list = $j('<ul>');

		$j.each( specification.specifications, function( index, element ){

			$list_el = $j('<li>');
			renderSpec( element, $list_el );
			$list.append( $list_el );
		});

		$new_div.append( $list );
	}
	else if( 'type' === specification.node ){

		var node_text = 'Type: ' + specification.type;
		$new_div.text( node_text );
	}
	else if( 'flt' === specification.node ){

		var node_text = specification.field + ' < ' + specification.value;
		$new_div.text( node_text );
	}
	else if( 'flte' === specification.node ){

		var node_text = specification.field + ' <= ' + specification.value;
		$new_div.text( node_text );
	}

	$new_div.appendTo( $container );
}

$j(function(){

	if( '' != specificationId ){

		var specification = loadSpecification( displaySpecification );
	}

});

	</script>
	<div id="specification_container">
	</div>
</apex:page>